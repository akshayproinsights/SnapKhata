<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Order Summary ‚Ä¢ SnapKhata</title>

    <!-- Open Graph for Professional WhatsApp Sharing -->
    <meta property="og:title" content="Order Summary ‚Ä¢ SnapKhata" />
    <meta property="og:description" content="View full order details and receipt." />
    <meta property="og:type" content="website" />
    <meta property="og:image"
        content="https://raw.githubusercontent.com/akshayproinsights/SnapKhata/main/web/icons/Icon-192.png" />
    <meta property="og:image:width" content="192" />
    <meta property="og:image:height" content="192" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --slate-50: #f8fafc;
            --slate-200: #e2e8f0;
            --slate-400: #94a3b8;
            --slate-600: #475569;
            --slate-900: #0f172a;
            --blue-50: #eff6ff;
            --blue-600: #2563eb;
            --green: #16a34a;
            --orange: #ea580c;
            --red: #dc2626;
            --bg-page: #f8fafc;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-page);
            color: var(--slate-900);
            line-height: 1.5;
        }

        /* Loader & Error */
        .loader-container,
        .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--bg-page);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--slate-200);
            border-top: 4px solid var(--blue-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            color: var(--slate-600);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .loader-subtext {
            color: var(--slate-400);
            font-size: 14px;
        }

        .brand {
            margin-top: 30px;
            font-size: 24px;
            font-weight: 700;
            color: var(--blue-600);
        }

        .error-container {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            color: var(--red);
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 24px;
        }

        .error-desc {
            color: var(--slate-600);
            margin-bottom: 24px;
            max-width: 400px;
            line-height: 1.6;
        }

        .btn-retry {
            background: var(--blue-600);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        /* Main Content */
        #content-container {
            display: none;
        }

        .page {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .mt-4 {
            margin-top: 20px;
        }

        /* Row Layouts */
        .row {
            display: flex;
            gap: 20px;
            align-items: stretch;
        }

        .flex-3 {
            flex: 3;
        }

        /* Header Card */
        .header-card {
            background: #fff;
            border-radius: 8px;
            border: 1px solid var(--slate-200);
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .header-top-bar {
            height: 4px;
            background: var(--blue-600);
            border-radius: 8px 8px 0 0;
            width: 100%;
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            width: calc(100% + 2px);
        }

        .header-content {
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .shop-name {
            font-size: 24px;
            font-weight: 800;
            color: var(--slate-900);
            margin: 0 0 8px 0;
            line-height: 1.2;
        }

        .shop-meta {
            font-size: 13px;
            color: var(--slate-600);
            line-height: 1.4;
            max-width: 90%;
            margin-bottom: 12px;
        }

        .shop-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip {
            padding: 4px 8px;
            background: #f1f5f9;
            border-radius: 4px;
            font-size: 11px;
            color: var(--slate-600);
            font-weight: 500;
        }

        .chip.highlight {
            background: var(--blue-50);
            color: var(--blue-600);
            font-weight: 600;
        }

        .invoice-meta-box {
            width: 220px;
            background: var(--blue-50);
            border-radius: 8px;
            padding: 16px;
            flex-shrink: 0;
        }

        .doc-label {
            color: var(--blue-600);
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 1.8px;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .meta-field {
            margin-bottom: 12px;
        }

        .meta-field:last-child {
            margin-bottom: 0;
        }

        .meta-field span {
            display: block;
            font-size: 10px;
            color: var(--slate-400);
            margin-bottom: 2px;
        }

        .meta-field strong {
            display: block;
            font-size: 14px;
            color: var(--slate-900);
            font-weight: 700;
        }

        /* Section Cards */
        .section-card {
            background: #fff;
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        .status-box {
            width: 220px;
            flex-shrink: 0;
        }

        .section-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--slate-400);
            letter-spacing: 1.4px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .customer-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 4px;
        }

        .customer-phone {
            font-size: 13px;
            color: var(--slate-600);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
        }

        .status-paid {
            background: #f0fdf4;
            color: var(--green);
            border: 1px solid var(--green);
        }

        .status-partial {
            background: #fff7ed;
            color: var(--orange);
            border: 1px solid var(--orange);
        }

        .status-unpaid {
            background: #fef2f2;
            color: var(--red);
            border: 1px solid var(--red);
        }

        .status-meta {
            font-size: 12px;
            color: var(--green);
            margin-top: 8px;
            font-weight: 600;
        }

        /* Items Table */
        .table-container {
            background: #fff;
            border-radius: 8px;
            border: 1px solid var(--slate-200);
            overflow: hidden;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .items-table th {
            background: var(--slate-900);
            color: #fff;
            padding: 14px 16px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-align: left;
        }

        .items-table td {
            padding: 12px 16px;
            font-size: 13px;
            color: var(--slate-900);
            border-bottom: 1px solid var(--slate-200);
        }

        .items-table tr:nth-child(even) td {
            background: var(--slate-50);
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .items-table th.center,
        .items-table td.center {
            text-align: center;
        }

        .items-table th.right,
        .items-table td.right {
            text-align: right;
        }

        .items-table td.bold {
            font-weight: 700;
        }

        /* Totals */
        .totals-wrapper {
            display: flex;
            justify-content: flex-end;
        }

        .totals-card {
            width: 320px;
            background: #fff;
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
        }

        .totals-row.top-line {
            border-top: 1px dashed var(--slate-200);
            margin-top: 8px;
            padding-top: 16px;
        }

        .totals-row.grand-total {
            font-size: 18px;
            font-weight: 800;
        }

        .totals-row .label {
            color: var(--slate-600);
        }

        .totals-row.grand-total .label {
            color: var(--slate-900);
        }

        .totals-row .val {
            font-weight: 700;
            color: var(--slate-900);
        }

        .val.green {
            color: var(--green);
        }

        .val.red {
            color: var(--red);
        }

        /* Footer */
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
            color: var(--slate-400);
            font-style: italic;
        }

        .fab-print {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 50;
        }

        .fab-print button {
            border: none;
            padding: 14px 24px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--slate-900);
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.3);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: transform 0.2s;
        }

        .fab-print button:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 650px) {
            .row {
                flex-direction: column;
                gap: 16px;
            }

            .invoice-meta-box,
            .status-box {
                width: 100%;
                border-radius: 8px;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
                padding: 16px;
            }

            .page {
                padding: 20px 12px;
            }

            .totals-wrapper {
                justify-content: stretch;
            }

            .totals-card {
                width: 100%;
            }

            .items-table th,
            .items-table td {
                padding: 10px 8px;
                font-size: 12px;
            }

            .shop-name {
                font-size: 20px;
            }

            .customer-name {
                font-size: 16px;
            }
        }

        @media print {
            body {
                background: #ffffff;
            }

            .page {
                padding: 0;
                max-width: 100%;
            }

            .fab-print,
            .header-top-bar {
                display: none;
            }

            .header-card,
            .section-card,
            .table-container,
            .totals-card {
                box-shadow: none;
                border: 1px solid #ccc;
            }

            .invoice-meta-box {
                background: #f3f4f6;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .items-table th {
                background: #111;
                color: #fff;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .status-paid {
                background: #f0fdf4 !important;
            }
        }
    </style>
</head>

<body>
    <!-- Loading State -->
    <div id="loader" class="loader-container">
        <div class="spinner"></div>
        <div class="loader-text">Loading your order...</div>
        <div class="loader-subtext">Fetching latest details securely</div>
        <div class="brand">SnapKhata</div>
    </div>

    <!-- Error State -->
    <div id="error-screen" class="error-container">
        <div class="error-icon">üîç</div>
        <h2 class="error-title" id="error-title">Order Not Found</h2>
        <p class="error-desc" id="error-message">The order link is invalid or the data is unavailable.</p>
        <button class="btn-retry" onclick="window.location.reload()">Try Again</button>
    </div>

    <!-- Main Content -->
    <div id="content-container">
        <div class="page">

            <!-- Header -->
            <div class="header-card">
                <div class="header-top-bar"></div>
                <div class="header-content row">
                    <div class="shop-info flex-3">
                        <h1 class="shop-name" id="shopName">My Shop</h1>
                        <div class="shop-meta" id="shopMeta"></div>
                        <div class="shop-chips" id="shopChips">
                            <div class="chip" id="shopPhone" style="display:none"></div>
                        </div>
                    </div>
                    <div class="invoice-meta-box">
                        <div class="doc-label" id="docLabel">INVOICE</div>
                        <div class="meta-field">
                            <span>Invoice No.</span>
                            <strong id="orderId">‚Äî</strong>
                        </div>
                        <div class="meta-field">
                            <span>Date</span>
                            <strong id="orderDate">DD/MM/YYYY</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bill To & Payment Status -->
            <div class="row mt-4">
                <div class="section-card flex-3">
                    <div class="section-label">BILL TO</div>
                    <div class="customer-name" id="customerName">Walk-in customer</div>
                    <div class="customer-phone" id="customerPhone"></div>
                </div>
                <div class="section-card status-box">
                    <div class="section-label">PAYMENT STATUS</div>
                    <div id="paymentStatusBadge" class="status-badge status-unpaid">UNPAID</div>
                    <div id="paymentStatusMeta" class="status-meta" style="display: none;"></div>
                </div>
            </div>

            <!-- Items Table -->
            <div class="table-container mt-4">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Item Description</th>
                            <th class="center">Qty</th>
                            <th class="right">Rate</th>
                            <th class="right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- dynamically injected -->
                    </tbody>
                </table>
            </div>

            <!-- Totals -->
            <div class="totals-wrapper mt-4">
                <div class="totals-card">
                    <div class="totals-row">
                        <span class="label">Subtotal</span>
                        <span class="val" id="subtotal">Rs.0</span>
                    </div>
                    <div class="totals-row" id="discountRow" style="display:none">
                        <span class="label">Discount</span>
                        <span class="val green" id="discount">-Rs.0</span>
                    </div>
                    <div class="totals-row" id="gstRow" style="display:none">
                        <span class="label" id="gstLabel">GST</span>
                        <span class="val" id="gst">Rs.0</span>
                    </div>
                    <div class="totals-row top-line grand-total">
                        <span class="label">TOTAL</span>
                        <span class="val" id="total">Rs.0</span>
                    </div>
                    <div class="totals-row top-line" id="paidRow" style="display:none">
                        <span class="label">Amount Paid</span>
                        <span class="val green" id="paid">Rs.0</span>
                    </div>
                    <div class="totals-row top-line" id="balanceRow" style="display:none">
                        <span class="label">Balance Due</span>
                        <span class="val red" id="balance" style="font-size: 15px;">Rs.0</span>
                    </div>
                </div>
            </div>

            <footer class="footer">
                Continued on next page...<br><br>
                Generated by <strong>SnapKhata</strong> &nbsp;&bull;&nbsp; Digital Records for Smart Business
            </footer>
        </div>

        <div class="fab-print">
            <button type="button" onclick="window.print()">
                <span>Download / Print</span>
            </button>
        </div>
    </div>

    <script>
        const fmtMoney = (v) => {
            const num = Number(v || 0);
            return 'Rs.' + num.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };

        const byId = (id) => document.getElementById(id);
        const hide = (id) => { byId(id).style.display = 'none'; };
        const show = (id) => { byId(id).style.display = 'block'; };
        const showFlex = (id) => { byId(id).style.display = 'flex'; };

        function showError(title, message) {
            hide('loader');
            showFlex('error-screen');
            if (title) byId('error-title').textContent = title;
            if (message) byId('error-message').textContent = message;
        }

        async function fetchOrderData() {
            const urlParams = new URLSearchParams(window.location.search);
            let orderId = urlParams.get('id');

            if (!orderId) {
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                if (pathParts.length > 0) orderId = pathParts[pathParts.length - 1];
            }

            if (!orderId || orderId === 'order') {
                showError('Invalid Link', 'No order ID was found in the URL. Please ask the sender for a valid link.');
                return;
            }

            try {
                const response = await fetch(`https://yblvrnaexonjpuegemwh.supabase.co/functions/v1/order-view/${orderId}`);
                if (!response.ok) throw new Error('Network response was not ok');

                const contentType = response.headers.get("content-type");
                let data = null;
                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    const htmlText = await response.text();
                    const dataRegex = /window\.__ORDER_DATA__\s*=\s*({[\s\S]*?});/i;
                    const match = htmlText.match(dataRegex);

                    if (!match || match.length < 2) {
                        document.open();
                        document.write(htmlText);
                        document.close();
                        return;
                    }
                    data = JSON.parse(match[1]);
                }

                renderData(data);
            } catch (err) {
                console.error(err);
                showError('Unable to Load Order', 'There was a problem fetching the order data. Please check your internet connection and try again.');
            }
        }

        function renderData(data) {
            if (!data) return;

            const shop = data.shop || {};
            const order = data.order || {};
            const customer = data.customer || {};

            // --- Shop Info ---
            if (shop.name) byId('shopName').textContent = shop.name;
            if (shop.address) byId('shopMeta').textContent = shop.address;

            if (shop.phone) {
                byId('shopPhone').textContent = 'Ph: ' + shop.phone;
                show('shopPhone');
            }

            // --- Order Info ---
            if (order.id) byId('orderId').textContent = order.id;

            if (order.dateISO) {
                const d = new Date(order.dateISO);
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                byId('orderDate').textContent = `${dd}/${mm}/${yyyy}`;
            }

            // --- Customer ---
            byId('customerName').textContent = customer.name || 'Walk-in Customer';
            if (customer.phone) byId('customerPhone').textContent = '+91 ' + customer.phone;

            // --- Status Badge ---
            const status = (order.paymentStatus || '').toLowerCase();
            const badge = byId('paymentStatusBadge');
            const statusMeta = byId('paymentStatusMeta');

            badge.className = 'status-badge';
            if (status === 'paid' || status === 'confirmed') {
                badge.classList.add('status-paid');
                badge.textContent = 'PAID';
            } else if (status === 'partial') {
                badge.classList.add('status-partial');
                badge.textContent = 'PARTIAL';
                if (order.paid > 0) {
                    statusMeta.textContent = 'Paid: ' + fmtMoney(order.paid);
                    show('paymentStatusMeta');
                }
            } else {
                badge.classList.add('status-unpaid');
                badge.textContent = 'UNPAID';
            }

            // --- Items ---
            const items = Array.isArray(data.items) ? data.items : [];
            const tbody = byId('itemsBody');
            tbody.innerHTML = '';

            items.forEach((item, idx) => {
                const tr = document.createElement('tr');
                const qty = Number(item.qty || 0);

                tr.innerHTML = `
                  <td class="center">${idx + 1}</td>
                  <td>${item.name || ''}</td>
                  <td class="center">${qty}</td>
                  <td class="right">${item.rate > 0 ? fmtMoney(item.rate) : '-'}</td>
                  <td class="right bold">${fmtMoney(item.amount || 0)}</td>
                `;
                tbody.appendChild(tr);
            });

            // --- Totals ---
            byId('subtotal').textContent = fmtMoney(order.subtotal || order.total || 0);

            if (order.discount && Number(order.discount) > 0) {
                byId('discount').textContent = `-${fmtMoney(order.discount)}`;
                showFlex('discountRow');
            }

            if (order.gstAmount && Number(order.gstAmount) > 0) {
                byId('gstLabel').textContent = order.gstPercent ? `GST (${Number(order.gstPercent).toFixed(0)}%)` : 'GST';
                byId('gst').textContent = fmtMoney(order.gstAmount);
                showFlex('gstRow');
            }

            byId('total').textContent = fmtMoney(order.total || 0);

            if (order.paid && Number(order.paid) > 0) {
                byId('paid').textContent = fmtMoney(order.paid);
                showFlex('paidRow');
            }

            const balance = Number(order.balance || 0);
            if (balance > 0) {
                byId('balance').textContent = fmtMoney(balance);
                showFlex('balanceRow');
            }

            hide('loader');
            show('content-container');
        }

        fetchOrderData();
    </script>
</body>

</html>