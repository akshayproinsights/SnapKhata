<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Order Summary ‚Ä¢ SnapKhata</title>

    <!-- Open Graph for Professional WhatsApp Sharing -->
    <meta property="og:title" content="Order Summary ‚Ä¢ SnapKhata" />
    <meta property="og:description" content="View full order details and receipt." />
    <meta property="og:type" content="website" />
    <meta property="og:image"
        content="https://raw.githubusercontent.com/akshayproinsights/SnapKhata/main/web/icons/Icon-192.png" />
    <meta property="og:image:width" content="192" />
    <meta property="og:image:height" content="192" />

    <style>
        :root {
            --bg: #ffffff;
            --card-bg: #ffffff;
            --accent: #2c3e50;
            --accent-soft: #f8f9fa;
            --text-main: #2c3e50;
            --text-muted: #6c757d;
            --border-subtle: #dee2e6;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            font-family: 'Georgia', 'Times New Roman', serif;
            background: #f8fafc;
            color: var(--text-main);
            line-height: 1.5;
        }

        /* Loader Styles */
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            color: #64748b;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .loader-subtext {
            color: #94a3b8;
            font-size: 14px;
        }

        .brand {
            margin-top: 30px;
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
        }

        /* Content Styles */
        #content-container {
            display: none;
        }

        .page {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #ffffff;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        /* Keep the beautiful card-based design from the Supabase edge function */
        .header {
            border-bottom: 3px solid var(--accent);
            padding: 20px 0;
            margin-bottom: 30px;
            text-align: center;
        }

        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .shop-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--accent);
            text-align: left;
        }

        .shop-meta {
            font-size: 14px;
            color: var(--text-muted);
            text-align: left;
        }

        .order-pill {
            text-align: right;
        }

        .order-pill>span {
            display: block;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .order-pill .badge {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: normal;
        }

        .card {
            margin-top: 14px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 14px 14px 12px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
            border: 1px solid var(--border-subtle);
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .customer-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            font-size: 13px;
        }

        .customer-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 16px;
        }

        .customer-phone {
            font-size: 13px;
            color: var(--text-muted);
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-chip--paid {
            background: #ecfdf3;
            color: var(--success);
            border: 1px solid rgba(22, 163, 74, 0.35);
        }

        .status-chip--partial {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid rgba(217, 119, 6, 0.35);
        }

        .status-chip--unpaid {
            background: #fef2f2;
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.35);
        }

        .items-card {
            margin-top: 14px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
            border: 1px solid var(--border-subtle);
        }

        .items-header {
            padding: 12px 14px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .items-header span.badge-soft {
            font-size: 12px;
            opacity: 0.9;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
        }

        .items-table thead {
            background: #f9fafb;
        }

        .items-table th,
        .items-table td {
            padding: 10px 12px;
            font-size: 13px;
            border-bottom: 1px solid var(--border-subtle);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .items-table th {
            text-align: left;
            font-weight: 600;
            color: var(--text-muted);
        }

        .items-table th.numeric,
        .items-table td.numeric {
            text-align: right;
        }

        .items-table td strong {
            color: var(--text-main);
            font-weight: 600;
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .items-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .summary-card {
            margin-top: 14px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.04);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin: 6px 0;
        }

        .summary-row .label {
            color: var(--text-muted);
        }

        .summary-row .value {
            font-weight: 600;
        }

        .summary-row.total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-subtle);
            font-size: 16px;
        }

        .summary-row.total .value {
            color: var(--text-main);
            font-weight: 700;
            font-size: 18px;
        }

        .summary-row.balance .value {
            color: var(--danger);
            font-size: 16px;
        }

        .summary-row.balance--cleared .value {
            color: var(--success);
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .footer strong {
            color: var(--accent);
        }

        .fab-print {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 50;
        }

        .fab-print button {
            border: none;
            outline: none;
            padding: 12px 20px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #111827;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 14px 35px rgba(15, 23, 42, 0.4);
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .fab-print button:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.5);
        }

        .fab-print button span.icon {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            background: #f9fafb;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #111827;
            font-size: 14px;
        }

        /* Error State */
        .error-container {
            display: none;
            text-align: center;
            padding: 40px 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: #f8fafc;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            color: #dc2626;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 24px;
        }

        .error-desc {
            color: #64748b;
            margin-bottom: 24px;
            max-width: 400px;
            line-height: 1.6;
        }

        .btn-retry {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-retry:hover {
            background: #1d4ed8;
        }

        @media print {
            body {
                background: #ffffff;
            }

            .page {
                padding: 0;
                max-width: 100%;
                box-shadow: none;
            }

            .fab-print {
                display: none;
            }

            .items-table tr {
                page-break-inside: avoid;
            }
        }

        @media (max-width: 600px) {
            .header-main {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .order-pill {
                text-align: left;
            }

            .items-table th,
            .items-table td {
                padding: 8px 6px;
                font-size: 12px;
            }

            .page {
                padding: 20px 15px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading State -->
    <div id="loader" class="loader-container">
        <div class="spinner"></div>
        <div class="loader-text">Loading your order...</div>
        <div class="loader-subtext">Fetching latest details securely</div>
        <div class="brand">SnapKhata</div>
    </div>

    <!-- Error State -->
    <div id="error-screen" class="error-container">
        <div class="error-icon">üîç</div>
        <h2 class="error-title" id="error-title">Order Not Found</h2>
        <p class="error-desc" id="error-message">The order link is invalid or the data is unavailable.</p>
        <button class="btn-retry" onclick="window.location.reload()">Try Again</button>
    </div>

    <!-- Main Content -->
    <div id="content-container">
        <div class="page">
            <header class="header">
                <div class="header-main">
                    <div>
                        <div class="shop-name" id="shopName">My Shop</div>
                        <div class="shop-meta" id="shopMeta">
                            <span id="shopAddress"></span>
                            <span id="shopPhone"></span>
                        </div>
                    </div>
                    <div class="order-pill">
                        <span>Order <span id="orderId">‚Äî</span></span>
                        <span class="badge" id="orderDate">DD/MM/YYYY</span>
                    </div>
                </div>
            </header>

            <section class="card" aria-labelledby="customer-heading">
                <div class="section-title" id="customer-heading">Customer</div>
                <div class="customer-row">
                    <div>
                        <div class="customer-name" id="customerName">Walk-in customer</div>
                        <div class="customer-phone" id="customerPhone"></div>
                    </div>
                    <div id="paymentStatusChip"></div>
                </div>
            </section>

            <section class="items-card" aria-labelledby="items-heading">
                <div class="items-header">
                    <span>Items Purchased</span>
                    <span class="badge-soft" id="itemsSummary"></span>
                </div>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Item</th>
                            <th class="numeric">Qty</th>
                            <th class="numeric">Rate</th>
                            <th class="numeric">Total</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- dynamically injected -->
                    </tbody>
                </table>
            </section>

            <section class="summary-card" aria-labelledby="summary-heading">
                <div class="section-title" id="summary-heading">Summary</div>
                <div class="summary-row">
                    <span class="label">Subtotal</span>
                    <span class="value" id="subtotal">‚Çπ0.00</span>
                </div>
                <div class="summary-row" id="discountRow" style="display: none">
                    <span class="label">Discount</span>
                    <span class="value" id="discount">-‚Çπ0.00</span>
                </div>
                <div class="summary-row" id="gstRow" style="display: none">
                    <span class="label" id="gstLabel">GST</span>
                    <span class="value" id="gst">‚Çπ0.00</span>
                </div>
                <div class="summary-row total">
                    <span class="label">Total Amount</span>
                    <span class="value" id="total">‚Çπ0.00</span>
                </div>
                <div class="summary-row" id="paidRow" style="display: none">
                    <span class="label">Amount Paid</span>
                    <span class="value" id="paid">‚Çπ0.00</span>
                </div>
                <div class="summary-row balance" id="balanceRow">
                    <span class="label">Balance Due</span>
                    <span class="value" id="balance">‚Çπ0.00</span>
                </div>
            </section>

            <footer class="footer">
                <div>Generated by <strong>SnapKhata</strong></div>
                <div>Keep this page to reprint or share anytime.</div>
            </footer>
        </div>

        <div class="fab-print">
            <button type="button" onclick="window.print()">
                <span class="icon">‚¨á</span>
                <span>Download / Print</span>
            </button>
        </div>
    </div>

    <script>
        // --- Safe Currency Formatter ---
        const fmtMoney = (v) => {
            const num = Number(v || 0);
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 2,
            }).format(num);
        };

        const byId = (id) => document.getElementById(id);
        const hide = (id) => { byId(id).style.display = 'none'; };
        const show = (id) => { byId(id).style.display = 'block'; };

        function showError(title, message) {
            hide('loader');
            show('error-screen');
            if (title) byId('error-title').textContent = title;
            if (message) byId('error-message').textContent = message;
        }

        async function fetchOrderData() {
            // Get order ID from URL (?id=...) or path
            const urlParams = new URLSearchParams(window.location.search);
            let orderId = urlParams.get('id');

            if (!orderId) {
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                if (pathParts.length > 0) {
                    orderId = pathParts[pathParts.length - 1]; // Fallback for e.g. /order/123
                }
            }

            if (!orderId || orderId === 'order') {
                showError('Invalid Link', 'No order ID was found in the URL. Please ask the sender for a valid link.');
                return;
            }

            try {
                // We use the REST endpoint of the public Supabase project. We need the anon key to query it directly from the browser.
                // It's safe to expose the anon key for read-only row level security (RLS) queries.
                // Note: Make sure the 'bills' table and 'bill_items' table have RLS policies that allow reading by ID.
                // If RLS prevents public reads, we would need a simple Edge Function just to return JSON data.
                // We will try calling the REST API first.

                // For SnapKhata, since these are public share links, we'll try to use the Edge function returning JSON or just HTML since we have it.
                // Wait, the existing `order-view` edge function returns HTML. If we just call it and extract the data... No, that's messy.
                // Let's call the `order-view` edge function and replace the document if it works, BUT we want our local design.

                // Actually, the best way for a purely static Vercel page is to call the REST endpoint. 
                // Do we have the anon key? The user has it in their .env, but I don't know it off the top of my head for the frontend injection.
                // Wait, the previous invoice.html did this:
                // fetch(`https://yblvrnaexonjpuegemwh.supabase.co/functions/v1/order-view/${orderId}`)
                // Let's use the exact same Edge Function! It already returns HTML with `window.__ORDER_DATA__` embedded in it!
                // It's brilliant. We can just fetch the edge function, parse the HTML, extract the `__ORDER_DATA__` JSON, and use it here in our gorgeous Vercel UI.

                const response = await fetch(`https://yblvrnaexonjpuegemwh.supabase.co/functions/v1/order-view/${orderId}`);
                if (!response.ok) throw new Error('Network response was not ok');

                const contentType = response.headers.get("content-type");

                let data = null;
                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    const htmlText = await response.text();
                    // Fallback to extract the JSON object from the returned HTML using Regex (if edge function is not fully updated yet)
                    const dataRegex = /window\.__ORDER_DATA__\s*=\s*({[\s\S]*?});/i;
                    const match = htmlText.match(dataRegex);

                    if (!match || match.length < 2) {
                        document.open();
                        document.write(htmlText);
                        document.close();
                        return;
                    }
                    data = JSON.parse(match[1]);
                }

                renderData(data);

            } catch (err) {
                console.error(err);
                showError('Unable to Load Order', 'There was a problem fetching the order data. Please check your internet connection and try again.');
            }
        }

        function renderData(data) {
            if (!data) return;

            const shop = data.shop || {};
            const order = data.order || {};
            const customer = data.customer || {};

            // --- Shop Info ---
            if (shop.name) byId('shopName').textContent = shop.name;

            const shopMetaParts = [];
            if (shop.address) shopMetaParts.push(shop.address);
            if (shop.phone) shopMetaParts.push(shop.phone);
            byId('shopMeta').innerHTML = shopMetaParts.join(' &bull; ');

            // --- Order Info ---
            if (order.id) byId('orderId').textContent = order.id;

            if (order.dateISO) {
                const d = new Date(order.dateISO);
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                byId('orderDate').textContent = `${dd}/${mm}/${yyyy}`;
            }

            // --- Customer ---
            byId('customerName').textContent = customer.name || 'Walk-in customer';
            if (customer.phone) byId('customerPhone').textContent = customer.phone;

            // Status Chip
            const status = (order.paymentStatus || '').toLowerCase();
            const chip = document.createElement('div');
            chip.classList.add('status-chip');

            if (status === 'paid' || status === 'confirmed') {
                chip.classList.add('status-chip--paid');
                chip.textContent = '‚úì Paid in full';
            } else if (status === 'partial') {
                chip.classList.add('status-chip--partial');
                chip.textContent = '‚ö† Partial payment';
            } else {
                chip.classList.add('status-chip--unpaid');
                chip.textContent = 'üïí Payment pending';
            }
            byId('paymentStatusChip').appendChild(chip);

            // --- Items ---
            const items = Array.isArray(data.items) ? data.items : [];
            const tbody = byId('itemsBody');
            tbody.innerHTML = '';

            let totalQty = 0;
            items.forEach((item, idx) => {
                const tr = document.createElement('tr');
                const qty = Number(item.qty || 0);
                totalQty += qty;

                tr.innerHTML = `
          <td>${idx + 1}</td>
          <td><strong>${item.name || ''}</strong></td>
          <td class="numeric">${qty.toLocaleString('en-IN')}</td>
          <td class="numeric">${fmtMoney(item.rate || 0)}</td>
          <td class="numeric"><strong>${fmtMoney(item.amount || 0)}</strong></td>
        `;
                tbody.appendChild(tr);
            });

            byId('itemsSummary').textContent = `${items.length} items ‚Ä¢ Qty ${totalQty.toLocaleString('en-IN')}`;

            // --- Summary ---
            byId('subtotal').textContent = fmtMoney(order.subtotal || order.total || 0);

            if (order.discount && Number(order.discount) > 0) {
                byId('discount').textContent = `-${fmtMoney(order.discount)}`;
                byId('discountRow').style.display = 'flex';
            }

            if (order.gstAmount && Number(order.gstAmount) > 0) {
                byId('gstLabel').textContent = order.gstPercent ? `GST (${Number(order.gstPercent).toFixed(0)}%)` : 'GST';
                byId('gst').textContent = fmtMoney(order.gstAmount);
                byId('gstRow').style.display = 'flex';
            }

            byId('total').textContent = fmtMoney(order.total || 0);

            if (order.paid && Number(order.paid) > 0) {
                byId('paid').textContent = fmtMoney(order.paid);
                byId('paidRow').style.display = 'flex';
            }

            const balance = Number(order.balance || 0);
            byId('balance').textContent = fmtMoney(balance);

            const balanceRow = byId('balanceRow');
            if (balance <= 0) {
                balanceRow.classList.add('balance--cleared');
                balanceRow.querySelector('.label').textContent = 'Cleared';
            }

            // Hide Loader, Show Content
            hide('loader');
            show('content-container');
        }

        // Initialize fetching on page load
        fetchOrderData();
    </script>
</body>

</html>