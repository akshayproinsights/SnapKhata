<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Order Summary ‚Ä¢ SnapKhata</title>

    <!-- Open Graph for Professional WhatsApp Sharing -->
    <meta property="og:title" content="Order Summary ‚Ä¢ SnapKhata" />
    <meta property="og:description" content="View full order details and receipt." />
    <meta property="og:type" content="website" />
    <meta property="og:image"
        content="https://raw.githubusercontent.com/akshayproinsights/SnapKhata/main/web/icons/Icon-192.png" />
    <meta property="og:image:width" content="192" />
    <meta property="og:image:height" content="192" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-page: #f8fafc;
            --border-color: #000000;
            --gray-bg: #e5e7eb;
            --blue-600: #2563eb;
            --slate-200: #e2e8f0;
            --slate-400: #94a3b8;
            --slate-600: #475569;
            --red: #dc2626;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-page);
            color: #000000;
            line-height: 1.5;
        }

        /* Loader & Error */
        .loader-container,
        .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--bg-page);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--slate-200);
            border-top: 4px solid var(--blue-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            color: var(--slate-600);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .loader-subtext {
            color: var(--slate-400);
            font-size: 14px;
        }

        .brand {
            margin-top: 30px;
            font-size: 24px;
            font-weight: 700;
            color: #000;
        }

        .error-container {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            color: var(--red);
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 24px;
        }

        .error-desc {
            color: var(--slate-600);
            margin-bottom: 24px;
            max-width: 400px;
            line-height: 1.6;
        }

        .btn-retry {
            background: #000;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        /* Main Content */
        #content-container {
            display: none;
        }

        .page {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .page-title {
            text-align: center;
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 24px;
            color: #000;
        }

        .main-box {
            background: #fff;
            border: 2px solid var(--border-color);
            margin-bottom: 24px;
        }

        .shop-section {
            padding: 16px 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .shop-name {
            font-size: 24px;
            font-weight: 800;
            margin: 0 0 6px 0;
            text-transform: uppercase;
        }

        .shop-address {
            font-size: 14px;
            margin: 0 0 4px 0;
        }

        .shop-phone,
        .shop-gst {
            font-size: 14px;
            margin: 0 0 4px 0;
            font-weight: 500;
        }

        .info-row {
            display: flex;
            border-bottom: 2px solid var(--border-color);
        }

        .info-col {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .info-col:first-child {
            border-right: 2px solid var(--border-color);
        }

        .info-header {
            background: var(--gray-bg);
            padding: 8px 12px;
            font-weight: 700;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-content {
            padding: 10px 12px;
            font-size: 14px;
            flex: 1;
        }

        .info-content>div {
            margin-bottom: 4px;
        }

        .info-content>div:last-child {
            margin-bottom: 0;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .items-table th,
        .items-table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            font-size: 14px;
        }

        /* Border resets for inner table to fuse with main box */
        .items-table th:first-child,
        .items-table td:first-child {
            border-left: none;
        }

        .items-table th:last-child,
        .items-table td:last-child {
            border-right: none;
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .items-table th {
            background: var(--gray-bg);
            font-weight: 700;
            text-align: left;
        }

        .items-table th.center,
        .items-table td.center {
            text-align: center;
        }

        .items-table th.right,
        .items-table td.right {
            text-align: right;
        }

        .font-bold {
            font-weight: 700;
        }

        .amount-words-cell {
            background: var(--gray-bg);
            vertical-align: top;
            padding: 10px 12px;
            border-top: 1px solid var(--border-color);
        }

        .amount-words-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .amount-words-text {
            font-size: 14px;
            font-weight: 500;
        }

        .terms-box {
            background: #fff;
            border: 2px solid var(--border-color);
            width: 60%;
        }

        .terms-header {
            background: var(--gray-bg);
            padding: 8px 12px;
            font-weight: 700;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .terms-content {
            padding: 10px 12px;
            font-size: 14px;
        }

        .fab-print {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 50;
        }

        .fab-print button {
            border: none;
            padding: 14px 24px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #000;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: transform 0.2s;
        }

        .fab-print button:hover {
            transform: translateY(-2px);
        }

        @media print {
            body {
                background: #fff;
            }

            .page {
                padding: 0;
                max-width: 100%;
                min-height: auto;
            }

            .fab-print {
                display: none;
            }

            .info-header,
            .items-table th,
            .amount-words-cell,
            .terms-header {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        @media (max-width: 650px) {
            .page {
                padding: 16px 12px;
            }

            .info-row {
                flex-direction: column;
            }

            .info-col:first-child {
                border-right: none;
                border-bottom: 2px solid var(--border-color);
            }

            .terms-box {
                width: 100%;
            }

            .items-table th,
            .items-table td {
                padding: 6px 8px;
                font-size: 12px;
            }

            .shop-name {
                font-size: 20px;
            }

            .info-header,
            .terms-header {
                font-size: 13px;
            }

            .info-content {
                font-size: 13px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading State -->
    <div id="loader" class="loader-container">
        <div class="spinner"></div>
        <div class="loader-text">Loading your order...</div>
        <div class="loader-subtext">Fetching latest details securely</div>
        <div class="brand">SnapKhata</div>
    </div>

    <!-- Error State -->
    <div id="error-screen" class="error-container">
        <div class="error-icon">üîç</div>
        <h2 class="error-title" id="error-title">Order Not Found</h2>
        <p class="error-desc" id="error-message">The order link is invalid or the data is unavailable.</p>
        <button class="btn-retry" onclick="window.location.reload()">Try Again</button>
    </div>

    <!-- Main Content -->
    <div id="content-container">
        <div class="page">
            <div class="page-title">Order Summary</div>

            <div class="main-box">
                <!-- Header -->
                <div class="shop-section">
                    <div class="shop-name" id="shopName">My Shop</div>
                    <div class="shop-address" id="shopMeta"></div>
                    <div class="shop-phone" id="shopPhone" style="display:none"></div>
                    <div class="shop-gst" id="shopGst" style="display:none"></div>
                </div>

                <!-- Order Details & Bill To -->
                <div class="info-row">
                    <div class="info-col">
                        <div class="info-header">Order Details:</div>
                        <div class="info-content">
                            <div><strong>No: </strong><strong id="orderId">‚Äî</strong></div>
                            <div><strong>Date: </strong><strong id="orderDate">DD-MM-YYYY</strong></div>
                        </div>
                    </div>
                    <div class="info-col">
                        <div class="info-header">Bill To:</div>
                        <div class="info-content">
                            <div style="font-weight: 700;" id="customerName">Walk-in customer</div>
                            <div id="customerPhone"></div>
                        </div>
                    </div>
                </div>

                <!-- Items Table -->
                <table class="items-table">
                    <thead>
                        <tr>
                            <th style="width: 5%; text-align: center;">#</th>
                            <th style="width: 45%;">Item Description</th>
                            <th style="width: 10%; text-align: center;">Qty</th>
                            <th style="width: 20%; text-align: right;">Rate</th>
                            <th style="width: 20%; text-align: right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- dynamically injected -->
                    </tbody>
                </table>
            </div>

            <div class="terms-box">
                <div class="terms-header">Terms And Conditions:</div>
                <div class="terms-content">Thank you for your business.</div>
            </div>

        </div>

        <div class="fab-print">
            <button type="button" onclick="window.print()">
                <span>Download / Print</span>
            </button>
        </div>
    </div>

    <script>
        const fmtMoney = (v) => {
            const num = Number(v || 0);
            return '‚Çπ ' + num.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).replace('‚Çπ ', '‚Çπ'); // No space after rupee symbol to match original request if any, but lets stick to standard
        };

        const flexLabel = (text) => {
            return `<div style="display: flex; justify-content: space-between;"><span>${text}</span><span>:</span></div>`;
        };

        function numberToWords(num) {
            if (num === 0) return 'Zero Rupees only';
            num = Math.floor(Math.abs(num));
            const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
            const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

            if (num.toString().length > 9) return 'Overflow';
            const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return;
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
            str += (n[5] != 0) ? (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + 'Rupees only' : 'Rupees only';
            return str.trim();
        }

        const byId = (id) => document.getElementById(id);
        const hide = (id) => { byId(id).style.display = 'none'; };
        const show = (id) => { byId(id).style.display = 'block'; };
        const showFlex = (id) => { byId(id).style.display = 'flex'; };

        function showError(title, message) {
            hide('loader');
            showFlex('error-screen');
            if (title) byId('error-title').textContent = title;
            if (message) byId('error-message').textContent = message;
        }

        async function fetchOrderData() {
            const urlParams = new URLSearchParams(window.location.search);
            let orderId = urlParams.get('id');

            if (!orderId) {
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                if (pathParts.length > 0) orderId = pathParts[pathParts.length - 1];
            }

            if (!orderId || orderId === 'order') {
                showError('Invalid Link', 'No order ID was found in the URL. Please ask the sender for a valid link.');
                return;
            }

            try {
                const response = await fetch(`https://yblvrnaexonjpuegemwh.supabase.co/functions/v1/order-view/${orderId}`);
                if (!response.ok) throw new Error('Network response was not ok');

                const contentType = response.headers.get("content-type");
                let data = null;
                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    const htmlText = await response.text();
                    const dataRegex = /window\.__ORDER_DATA__\s*=\s*({[\s\S]*?});/i;
                    const match = htmlText.match(dataRegex);

                    if (!match || match.length < 2) {
                        document.open();
                        document.write(htmlText);
                        document.close();
                        return;
                    }
                    data = JSON.parse(match[1]);
                }

                renderData(data);
            } catch (err) {
                console.error(err);
                showError('Unable to Load Order', 'There was a problem fetching the order data. Please check your internet connection and try again.');
            }
        }

        function renderData(data) {
            if (!data) return;

            const shop = data.shop || {};
            const order = data.order || {};
            const customer = data.customer || {};

            // --- Shop Info ---
            if (shop.name) byId('shopName').textContent = shop.name;
            if (shop.address) byId('shopMeta').textContent = shop.address;

            if (shop.phone) {
                byId('shopPhone').textContent = '+91 ' + shop.phone.replace('+91', '').trim();
                show('shopPhone');
            }

            if (shop.gst) {
                byId('shopGst').textContent = 'GSTIN: ' + shop.gst;
                show('shopGst');
            }

            // --- Order Info ---
            if (order.id) byId('orderId').textContent = order.id;

            if (order.dateISO) {
                const d = new Date(order.dateISO);
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                byId('orderDate').textContent = `${dd}-${mm}-${yyyy}`;
            }

            // --- Customer ---
            byId('customerName').textContent = customer.name || 'Walk-in Customer';
            if (customer.phone) {
                byId('customerPhone').textContent = '+91 ' + customer.phone.replace('+91', '').trim();
            }

            // --- Items ---
            const items = Array.isArray(data.items) ? data.items : [];
            const tbody = byId('itemsBody');
            tbody.innerHTML = '';

            items.forEach((item, idx) => {
                const tr = document.createElement('tr');
                const qty = Number(item.qty || 0);

                tr.innerHTML = `
                  <td class="center">${idx + 1}</td>
                  <td>${item.name || ''}</td>
                  <td class="center">${qty}</td>
                  <td class="right">${item.rate > 0 ? fmtMoney(item.rate) : '-'}</td>
                  <td class="right">${fmtMoney(item.amount || 0)}</td>
                `;
                tbody.appendChild(tr);
            });

            // --- Totals ---
            // Calculate number of rows dynamically added to the bottom structure
            // We have Subtotal, and Total as standard top block (2)
            // Plus possible Discount and GST
            const orderSubtotal = Number(order.subtotal || order.total || 0);
            const discountAmt = Number(order.discount || 0);
            const gstAmt = Number(order.gstAmount || 0);

            let topTotalCount = 2;
            if (discountAmt > 0) topTotalCount++;
            if (gstAmt > 0) topTotalCount++;

            let totalsHtml = `
                <tr>
                    <td colspan="3" rowspan="${topTotalCount}" style="border-right: 1px solid #000; border-bottom: 1px solid #000; background: #fff;"></td>
                    <td>${flexLabel('Sub Total')}</td>
                    <td class="right font-bold">${fmtMoney(orderSubtotal)}</td>
                </tr>
            `;

            if (discountAmt > 0) {
                totalsHtml += `
                <tr>
                    <td>${flexLabel('Discount')}</td>
                    <td class="right">-${fmtMoney(discountAmt)}</td>
                </tr>`;
            }

            if (gstAmt > 0) {
                const gstLabel = order.gstPercent ? `GST (${Number(order.gstPercent).toFixed(0)}%)` : 'GST';
                totalsHtml += `
                <tr>
                    <td>${flexLabel(gstLabel)}</td>
                    <td class="right">${fmtMoney(gstAmt)}</td>
                </tr>`;
            }

            totalsHtml += `
                <tr>
                    <td class="font-bold">${flexLabel('Total')}</td>
                    <td class="right font-bold">${fmtMoney(order.total || 0)}</td>
                </tr>
            `;

            const amountWords = numberToWords(order.total || 0);

            // Amount in words cell + Received & Balance
            totalsHtml += `
                <tr>
                    <td colspan="3" rowspan="2" class="amount-words-cell">
                        <div class="amount-words-title">Order Amount In Words :</div>
                        <div class="amount-words-text">${amountWords}</div>
                    </td>
                    <td>${flexLabel('Received')}</td>
                    <td class="right">${fmtMoney(order.paid || 0)}</td>
                </tr>
                <tr>
                    <td>${flexLabel('Balance')}</td>
                    <td class="right">${fmtMoney(order.balance || 0)}</td>
                </tr>
            `;

            tbody.insertAdjacentHTML('beforeend', totalsHtml);

            hide('loader');
            show('content-container');
        }

        fetchOrderData();
    </script>
</body>

</html>